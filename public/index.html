<html lang="en">
  <head>
    <link href="https://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <title>Cold War Nuclear Arms Race</title>
    <meta charset="utf-8">
    <!-- Start Added by Ian -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <!-- End Added by Ian -->

    <!--Bootstrap-->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  </head>
    <body>
      <ol class="breadcrumb">
        <div class="page-header headerMargin">
          <h1>Cold War Nuclear Arms Race <small>A Visualization</small></h1>
          <h4>Ian Banatoski, Luke Buquicchio, Tyler Bennett</h2>
        </div>
      </ol>

      <svg width="1300" height="500"></svg>

      <div id="countries">
      </div>
    </body>
    <script type="text/javascript">
      var nuclearInvData = [];
      var partitionedNukeInv = [];
      var nuclearTestData = [];

      var compiled = _.template(
        "<div class='countries'>" +
          "<h2><%= Country %></h2>" +
          "<p><%= Year %></p>" +
          "<p><%= InventorySize %></p>" +
        "</div>"
      );

          // Fancy thing.
      if( false && localStorage && localStorage.getItem('nuclearInvData') ) {
      console.log('loading from local');
      buildList( JSON.parse(localStorage.getItem('nuclearInvData')) )
      loadDataIntoGlobals('/nuclearInvData', JSON.parse(localStorage.getItem('nuclearInvData')) )
      loadDataIntoGlobals('/nuclearTests', JSON.parse(localStorage.getItem('nuclearTests')) )
      } else {
        console.log('loading from server');
        getJSON('/worldNuclearInventory');
        getJSON('/nuclearTests');
      }

      function loadDataIntoGlobals (datasetName, jsonObj){
        if( datasetName === '/nuclearInvData') {
          nuclearInvData = jsonObj;
          console.log('-----------nuclearInvData-------------');
          console.log(nuclearInvData);
          partitionedNukeInv = _.values(_.groupBy(nuclearInvData, "Country"));
          drawEachGraph(partitionedNukeInv[0]);
          _.map(partitionedNukeInv, function doStuff(n) {
              _.map(n, drawEachGraph(d) {
                drawEachGraph(d);
              });
          });
        } else if (datasetName === '/nuclearTests'){
          console.log('-----------nuclearTestData-------------');
          console.log(nuclearTestData);
          nuclearTestData = jsonObj;
        }
      }

      function getJSON(url) {
        var req = new XMLHttpRequest();
        req.onreadystatechange = function() {
          if (url === '/worldNuclearInventory') {
            handleInvRes(req);
          } else if (url === '/nuclearTests'){
            handleTestRes(req);
          }
        }

        req.open('GET', url);
        req.send();
      }

      function handleTestRes(req) {
        if( req.readyState !== XMLHttpRequest.DONE )
        return;

        if(req.status === 200) {
          nuclearTestData = JSON.parse(req.responseText);
          loadDataIntoGlobals('/nuclearTestData', JSON.parse(localStorage.getItem('nuclearTestData')) )
          localStorage.setItem('/nuclearTestData', req.responseText);
        }
      }

      function handleInvRes(req) {
        if( req.readyState !== XMLHttpRequest.DONE )
        return;

        if(req.status === 200) {
          nuclearInvData = JSON.parse(req.responseText);
          loadDataIntoGlobals('/nuclearInvData', JSON.parse(localStorage.getItem('nuclearInvData')) )
          localStorage.setItem('/nuclearInvData', req.responseText);

          buildList( nuclearInvData )
        }
      }

      function buildList( A ) {
        var i, toAppendString = "";
        for (i = 0; i < A.length; i++) {

          toAppendString += compiled(A[i]);
        }
        document.querySelector("#countries").innerHTML = toAppendString;
      }




      //--------------------------------------------------------------------------------------------------------------------------------------------------------
                      //  D3 Section Below
      //--------------------------------------------------------------------------------------------------------------------------------------------------------

      function drawEachGraph (countryData) {
        var svg = d3.select("svg"),
        margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;
        var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
            y = d3.scaleLinear().rangeRound([height, 0]);

        var g = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        console.log('manipulate data');
        x.domain(countryData.map(function(d) { return d.Year; }));
        y.domain([0, d3.max(countryData, function(d) { return d.InventorySize; })]);

        g.append("g")
            .attr("class", "axis axis--x")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        g.append("g")
            .attr("class", "axis axis--y")
            .call(d3.axisLeft(y).ticks(10))
          .append("text")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("Year");

        g.selectAll(".bar")
          .data(countryData)
          .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.Year); })
            .attr("y", function(d) { return y(d.InventorySize); })
            .attr("width", x.bandwidth())
            .attr("height", function(d) { return height - y(d.InventorySize); });
          }


    </script>
</html>
