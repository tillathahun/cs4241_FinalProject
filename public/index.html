<html lang="en">
  <head>
    <link href="https://fonts.googleapis.com/css?family=Fjalla+One|Open+Sans" rel="stylesheet">
    <title>CS4241 Assignment 2</title>
    <meta charset="utf-8">
    <!-- Start Added by Ian -->
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <!-- End Added by Ian -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>
    <body>
      <h1> LocalStorage Examples ~ FlightBook </h1>
      <div id="countries">
      </div>
    </body>
    <script type="text/javascript">
      var nuclearInvData = [];

      console.log(nuclearInvData)

      var compiled = _.template(
        "<div class='countries'>" +
          "<h2><%= Country %></h2>" +
          "<p><%= Year %></p>" +
          "<p><%= InventorySize %></p>" +
        "</div>"
      );

          // Fancy thing.
      if( localStorage && localStorage.getItem('nuclearInvData') ) {
      console.log('loading from local');
      buildList( JSON.parse(localStorage.getItem('nuclearInvData')) )
      loadDataIntoGlobals( JSON.parse(localStorage.getItem('nuclearInvData')) )
      } else {
      console.log('loading from server');
      getJSON('/worldNuclearInventory');
      }

      function loadDataIntoGlobals (jsonObj){
        console.log(jsonObj)
        jsonObj.forEach( function(element) {
          console.log(element);
          nuclearInvData.push(element);
        });
      }

      function getJSON(url) {
      var req = new XMLHttpRequest();
      req.onreadystatechange = function() {
        handleRes(req);
      }

      req.open('GET', url);
      req.send();
      }

      function handleRes(req) {
        if( req.readyState !== XMLHttpRequest.DONE )
        return;

        if(req.status === 200) {
          nuclearInvData = JSON.parse(req.responseText);
          loadDataIntoGlobals( JSON.parse(req.responseText) )
          localStorage.setItem('nuclearInvData', req.responseText);
          buildList( nuclearInvData )
        }
      }

      function buildList( A ) {
        console.log(nuclearInvData)
        var i, toAppendString = "";
        for (i = 0; i < A.length; i++) {

          toAppendString += compiled(A[i]);
        }
        document.querySelector("#countries").innerHTML = toAppendString;
      }

    </script>
</html>
